<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SFDP Stake Decentralization Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/jsvectormap@1.6.0/dist/jsvectormap.min.js"></script>
<script src="https://unpkg.com/jsvectormap@1.6.0/dist/maps/world.js"></script>
<link rel="stylesheet" href="https://unpkg.com/jsvectormap@1.6.0/dist/css/jsvectormap.min.css">
<style>
.jvm-tooltip { background: #161b22 !important; border: 1px solid #58a6ff !important; color: #e6edf3 !important; font-family: inherit !important; font-size: 13px !important; padding: 8px 12px !important; border-radius: 8px !important; box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important; line-height: 1.6 !important; }
</style>
<style>
:root{--bg:#0d1117;--surface:#161b22;--border:#30363d;--text:#e6edf3;--dim:#8b949e;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--purple:#bc8cff;--orange:#d29922;--yellow:#e3b341}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
.container{max-width:1440px;margin:0 auto;padding:24px}
header{margin-bottom:24px}
h1{font-size:22px;font-weight:600}
h1 span{color:var(--accent)}
.meta{color:var(--dim);font-size:12px;margin-top:4px}
.tabs{display:flex;gap:4px;margin-bottom:20px;flex-wrap:wrap}
.tab{padding:7px 14px;background:var(--surface);border:1px solid var(--border);border-radius:6px;cursor:pointer;color:var(--dim);font-size:13px}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.tab:hover:not(.active){color:var(--text);border-color:var(--dim)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px}
.card h3{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.card .val{font-size:24px;font-weight:700}
.card .sub{font-size:12px;color:var(--dim);margin-top:2px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:20px}
@media(max-width:900px){.row2,.row3{grid-template-columns:1fr}}
.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px}
.chart-box h3{font-size:14px;margin-bottom:12px}
canvas{max-height:320px}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:8px 10px;border-bottom:2px solid var(--border);color:var(--dim);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.3px;position:sticky;top:0;background:var(--surface)}
td{padding:6px 10px;border-bottom:1px solid var(--border)}
tr:hover td{background:rgba(88,166,255,.04)}
.mono{font-family:'SF Mono',Monaco,Consolas,monospace;font-size:12px}
.bar{display:inline-block;height:5px;border-radius:3px;background:var(--accent);min-width:2px;vertical-align:middle;margin-left:4px}
.tw{max-height:500px;overflow-y:auto;border-radius:10px}
.search{padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;width:280px;margin-bottom:8px}
.search:focus{outline:none;border-color:var(--accent)}
.section{font-size:16px;font-weight:600;margin:28px 0 12px}
.badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:11px;font-weight:500}
.badge-green{background:rgba(63,185,80,.15);color:var(--green)}
.badge-red{background:rgba(248,81,73,.15);color:var(--red)}
.badge-blue{background:rgba(88,166,255,.15);color:var(--accent)}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
<header>
<h1>üèõÔ∏è Solana Foundation <span>Delegation Program</span> ‚Äî Decentralization Dashboard</h1>
<div class="meta" id="meta"></div>
</header>

<div id="view-combined"></div>
</div>

<script>
let D;
const $ = id => document.getElementById(id);

// Country to continent mapping
const COUNTRY_CONTINENT = {
  'United States':'North America','Canada':'North America','Mexico':'North America',
  'Brazil':'South America','Argentina':'South America','Chile':'South America','Colombia':'South America','Peru':'South America',
  'Germany':'Europe','Netherlands':'Europe','France':'Europe','United Kingdom':'Europe','Ireland':'Europe',
  'Sweden':'Europe','Norway':'Europe','Poland':'Europe','Ukraine':'Europe','Romania':'Europe','Spain':'Europe',
  'Austria':'Europe','Bulgaria':'Europe','Czech Republic':'Europe','Estonia':'Europe','Latvia':'Europe',
  'Luxembourg':'Europe','Russia':'Europe','Republic of Lithuania':'Europe','Slovak Republic':'Europe',
  'Finland':'Europe','Denmark':'Europe','Belgium':'Europe','Portugal':'Europe','Italy':'Europe',
  'Switzerland':'Europe','Lithuania':'Europe','Turkey':'Europe',
  'Japan':'Asia','Singapore':'Asia','Hong Kong':'Asia','South Korea':'Asia','India':'Asia',
  'Thailand':'Asia','Indonesia':'Asia','Taiwan':'Asia','Philippines':'Asia','Vietnam':'Asia','Israel':'Asia',
  'South Africa':'Africa',
  'Australia':'Oceania','New Zealand':'Oceania',
};

// Country name to ISO 2-letter code mapping
const COUNTRY_ISO = {
  'United States':'US','Germany':'DE','Netherlands':'NL','France':'FR','United Kingdom':'GB',
  'Canada':'CA','Japan':'JP','Singapore':'SG','Ireland':'IE','Sweden':'SE','Norway':'NO',
  'Brazil':'BR','Poland':'PL','Ukraine':'UA','Romania':'RO','Spain':'ES','Hong Kong':'HK',
  'Argentina':'AR','Austria':'AT','Bulgaria':'BG','Chile':'CL','Czech Republic':'CZ',
  'Estonia':'EE','Latvia':'LV','Luxembourg':'LU','Mexico':'MX','Russia':'RU',
  'Republic of Lithuania':'LT','Slovak Republic':'SK','South Africa':'ZA','Unknown':'XX',
  'Australia':'AU','India':'IN','South Korea':'KR','Italy':'IT','Switzerland':'CH',
  'Finland':'FI','Denmark':'DK','Belgium':'BE','Portugal':'PT','Turkey':'TR',
  'Thailand':'TH','Indonesia':'ID','Colombia':'CO','Peru':'PE','Taiwan':'TW',
  'Philippines':'PH','Vietnam':'VN','Israel':'IL','New Zealand':'NZ','Lithuania':'LT',
};
const fmt = (n,d=1) => n>=1e6?(n/1e6).toFixed(d)+'M':n>=1e3?(n/1e3).toFixed(d)+'K':n.toFixed(d);
const fmtS = n => fmt(n)+' SOL';
const pct = (a,b) => b>0?((a/b)*100).toFixed(2)+'%':'0%';

function makeCards(items) {
  return '<div class="grid">'+items.map(c=>`<div class="card"><h3>${c.t}</h3><div class="val">${c.v}</div><div class="sub">${c.s||''}</div></div>`).join('')+'</div>';
}

function makeTable(id, headers, rows) {
  return `<input class="search" placeholder="Search..." oninput="filterT('${id}',this.value)">
<div class="tw"><table id="${id}"><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
<tbody>${rows.map(r=>'<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>').join('')}</tbody></table></div>`;
}

function filterT(id,q) {
  document.querySelectorAll('#'+id+' tbody tr').forEach(r=>{
    r.style.display=r.textContent.toLowerCase().includes(q.toLowerCase())?'':'none';
  });
}

function pieChart(canvasId, labels, data, colors) {
  new Chart($(canvasId),{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors||palette(labels.length),borderWidth:0}]},
    options:{responsive:true,plugins:{legend:{position:'right',labels:{color:'#e6edf3',font:{size:11},boxWidth:12}}}}});
}

function barChart(canvasId, labels, datasets, opts={}) {
  const fmtSOL = (v) => typeof v==='number'? fmt(v,0)+' SOL' : v;
  const fmtNum = (v) => typeof v==='number'? fmt(v,0) : v;
  const fmtCount = (v) => typeof v==='number'? v.toLocaleString() : v;
  // Pick smart default formatters based on data
  const defaultFmt = opts.isCount ? fmtCount : fmtSOL;
  new Chart($(canvasId),{type:'bar',data:{labels,datasets},
    options:{responsive:true,indexAxis:opts.horizontal?'y':'x',
      scales:{
        x:{stacked:opts.stacked,
          title:{display:!!opts.xLabel,text:opts.xLabel||'',color:'#8b949e'},
          ticks:{color:'#8b949e',callback:opts.fmtX||(opts.horizontal?defaultFmt:undefined),maxRotation:opts.horizontal?0:45},
          grid:{color:'#30363d22'}},
        y:{stacked:opts.stacked,
          title:{display:!!opts.yLabel,text:opts.yLabel||'',color:'#8b949e'},
          ticks:{color:'#8b949e',callback:opts.fmtY||(opts.horizontal?undefined:defaultFmt)},
          grid:{color:'#30363d22'}}
      },
      plugins:{
        legend:{display:datasets.length>1,labels:{color:'#e6edf3',font:{size:11}}},
        tooltip:{callbacks:{label:(ctx)=>{
          const v = ctx.parsed[opts.horizontal?'x':'y'];
          return ctx.dataset.label+': '+(opts.isCount?v.toLocaleString():fmt(v,1)+' SOL');
        }}}
      }}});
}

const palette = n => {
  const p=['#58a6ff','#3fb950','#bc8cff','#d29922','#f85149','#39d353','#f778ba','#79c0ff','#56d364','#e3b341','#ff7b72','#a5d6ff','#7ee787','#d2a8ff','#ffa657'];
  return Array.from({length:n},(_,i)=>p[i%p.length]);
};

function renderAccountView(containerId, data, color) {
  const el = $(containerId);
  const dec = data.decentralization;
  const ss = data.stakeStats;

  let html = makeCards([
    {t:'Active Stake',v:fmtS(data.totalActive),s:`${fmtS(data.totalDeactivating)} deactivating`},
    {t:'Active Validators',v:data.activeValidators,s:`${data.totalAccounts} stake accounts`},
    {t:'Nakamoto Coefficient',v:dec.nakamotoCoeff33,s:'validators for 33% stake'},
    {t:'HHI Index',v:dec.hhi.toFixed(6),s:dec.hhi<0.01?'<span class="badge badge-green">Low concentration</span>':'<span class="badge badge-red">Concentrated</span>'},
    {t:'Gini Coefficient',v:dec.gini.toFixed(4),s:dec.gini<0.3?'<span class="badge badge-green">Fairly equal</span>':'Moderate inequality'},
    {t:'Top Validator Share',v:dec.topValidatorPct.toFixed(1)+'%',s:`Top 10: ${dec.top10Pct.toFixed(1)}%`},
    {t:'Mean / Median Stake',v:fmtS(ss.mean),s:`Median: ${fmtS(ss.median)}`},
    {t:'Jito Validators',v:`${data.jitoStats.validators} (${data.jitoStats.pct}%)`,s:`${fmtS(data.jitoStats.stake)} staked`},
  ]);

  // Charts row: geo + commission
  const cid = containerId.replace('view-','');
  html += `<div class="row2">
    <div class="chart-box"><h3>üåç Geographic Distribution</h3><div id="${cid}-map" style="width:100%;height:320px"></div>
      <div id="${cid}-map-legend" style="margin-top:10px;font-size:12px;color:var(--dim)"></div></div>
    <div class="chart-box"><h3>üè¢ ASN Distribution (Top 10)</h3><canvas id="${cid}-asn"></canvas></div>
  </div>
  <div class="row2">
    <div class="chart-box"><h3>üí∞ Commission Distribution</h3><canvas id="${cid}-commission"></canvas></div>`;

  html += `<div class="row2">
    <div class="chart-box"><h3>üìä Stake Buckets</h3><canvas id="${cid}-buckets"></canvas></div>
    <div class="chart-box"><h3>üñ•Ô∏è Software Versions</h3><canvas id="${cid}-versions"></canvas></div>
  </div>`;

  // Top validators horizontal bar
  html += `<div class="chart-box"><h3>Top 25 Validators by Stake</h3><canvas id="${cid}-top25"></canvas></div>`;

  // Validator table
  const vrows = data.validators.filter(v=>v.activeStake>0).sort((a,b)=>b.activeStake-a.activeStake).map((v,i)=>[
    i+1,
    `<span class="mono">${v.voter.slice(0,12)}‚Ä¶</span>`,
    v.name||'‚Äî',
    v.activeStake.toLocaleString(undefined,{maximumFractionDigits:0}),
    v.pctOfPool.toFixed(2)+'%<span class="bar" style="width:'+Math.max(2,v.pctOfPool*4)+'px"></span>',
    v.commission!=null?v.commission+'%':'‚Äî',
    v.country||'‚Äî',
    v.asnOrg?v.asnOrg.slice(0,20):'‚Äî',
    v.version||'‚Äî',
    v.skipRate!=null?v.skipRate.toFixed(1)+'%':'‚Äî',
    v.isJito?'‚úÖ':'‚Äî',
    v.delinquent?'<span class="badge badge-red">Yes</span>':'‚Äî',
  ]);

  html += `<div class="chart-box"><h3>All Validators</h3>`+
    makeTable(cid+'-table',['#','Vote Account','Name','Active Stake','% Pool','Comm.','Country','ASN','Version','Skip%','Jito','Delinq.'],vrows)+
    '</div>';

  el.innerHTML = html;

  // Render charts
  const geo = data.geographic;

  // Country map
  const cStakes = {};
  for (const c of geo.countries) {
    const iso = COUNTRY_ISO[c.name];
    if (iso && iso !== 'XX') cStakes[iso] = c.stake;
  }
  new jsVectorMap({
    selector: '#'+cid+'-map',
    map: 'world',
    backgroundColor: 'transparent',
    regionStyle: {
      initial: { fill: '#1b1f24', stroke: '#444c56', strokeWidth: 0.5 },
      hover: { fill: '#2d333b', cursor: 'pointer' },
    },
    series: { regions: [{ values: cStakes, scale: ['#2ea043', '#f0e442', '#e5534b'], normalizeFunction: 'polynomial' }] },
    onRegionTooltipShow(evt, tip, code) {
      const s = cStakes[code];
      const name = tip.text();
      if (s) {
        const pctVal = (s/data.totalActive*100).toFixed(1);
        const cEntry = geo.countries.find(c=>COUNTRY_ISO[c.name]===code);
        const valCount = cEntry ? cEntry.count : '?';
        let html = '<b>'+name+'</b><br>';
        html += 'Stake: <b>'+fmt(s)+' SOL</b> ('+pctVal+'%)<br>';
        html += 'Validators: '+valCount;
        tip.text(html, true);
      } else {
        tip.text('<b>'+name+'</b><br>No SFDP stake', true);
      }
    },
  });
  // Country legend
  const cSorted = [...geo.countries].sort((a,b)=>b.stake-a.stake);
  $(cid+'-map-legend').innerHTML = cSorted.slice(0,15).map(c =>
    `<span style="margin-right:12px"><b>${c.name}</b>: ${fmt(c.stake)} SOL (${c.pct}%)</span>`
  ).join('');

  const topASN = geo.topASNs.slice(0,10);
  barChart(`${cid}-asn`, topASN.map(a=>a.name.length>22?a.name.slice(0,20)+'‚Ä¶':a.name), [{label:'Stake (SOL)',data:topASN.map(a=>a.stake),backgroundColor:color||'#58a6ff'}], {horizontal:true,xLabel:'Stake (SOL)'});

  const comm = data.commissionDistribution;
  pieChart(`${cid}-commission`, comm.map(c=>c.name+'%'), comm.map(c=>c.stake));

  const bk = data.stakeBuckets;
  barChart(`${cid}-buckets`, bk.map(b=>b.label+' SOL'), [
    {label:'Validator Count',data:bk.map(b=>b.count),backgroundColor:'#58a6ff'},
  ], {isCount:true, xLabel:'Stake Range', yLabel:'Number of Validators'});

  const ver = data.software.versions;
  pieChart(`${cid}-versions`, ver.map(v=>v.name), ver.map(v=>v.stake));

  const t25 = data.validators.filter(v=>v.activeStake>0).sort((a,b)=>b.activeStake-a.activeStake).slice(0,25);
  barChart(`${cid}-top25`, t25.map(v=>(v.name||v.voter.slice(0,8)+'‚Ä¶').slice(0,20)),
    [{label:'Active Stake (SOL)',data:t25.map(v=>v.activeStake),backgroundColor:color||'#58a6ff'}],
    {horizontal:true,xLabel:'Active Stake (SOL)'});
}

function renderCombined() {
  const el = $('view-combined');
  const f = D.accounts.firep, m = D.accounts.mpa4, c = D.combined;

  const infra = c.infraConcentration || {};
  const compliance = c.commissionCompliance || {};
  const fvn = c.foundationVsNetwork || {};
  const econ = c.validatorEconomics || {};

  const sfdpPct = fvn.sfdpPctOfTracked ? fvn.sfdpPctOfTracked + '%' : 'N/A';
  const medianStake = econ.medianStakeSOL ? fmtS(econ.medianStakeSOL) : 'N/A';
  const annualReward = econ.estAnnualRewardSOL ? fmtS(econ.estAnnualRewardSOL) : 'N/A';

  let html = makeCards([
    {t:'Total SFDP Stake',v:fmtS(c.totalActiveStake),s:`FiRep: ${fmtS(f.totalActive)} ¬∑ mpa4: ${fmtS(m.totalActive)}`},
    {t:'Total Validators in SFDP',v:c.uniqueValidators,s:`FiRep: ${f.activeValidators} ¬∑ mpa4: ${m.activeValidators} ¬∑ Network: ${D.networkValidators}`},
    {t:'Combined Nakamoto Coeff.',v:c.nakamotoCoeff33,s:`FiRep: ${f.decentralization.nakamotoCoeff33} ¬∑ mpa4: ${m.decentralization.nakamotoCoeff33}`},
    {t:'SFDP % of Network',v:sfdpPct,s:`${fmtS(fvn.trackedNetworkStake||0)} total tracked stake`},
    {t:'Top 3 ASN Concentration',v:(infra.top3ASNPct||'N/A')+'%',s:`${infra.uniqueASNs||0} unique hosting providers`},
    {t:'Commission Compliance',
      v: (compliance.highCommissionCount||0) === 0 ? '<span class="badge badge-green">‚úì All ‚â§10%</span>' : `<span class="badge badge-red">${compliance.highCommissionCount} over 10%</span>`,
      s:`Jito >10% cap: ${compliance.jitoOverCapCount||0} flagged`},
    {t:'Deactivating Stake',v:fmtS(f.totalDeactivating+m.totalDeactivating),s:`FiRep: ${fmtS(f.totalDeactivating)} ¬∑ mpa4: ${fmtS(m.totalDeactivating)}`},
    {t:'Median Validator Stake',v:medianStake,s:`Est. ${annualReward}/yr reward ¬∑ ${econ.validatorsInProgram||0} validators in program`},
  ]);

  html += `<div class="row2">
    <div class="chart-box"><h3>üñ•Ô∏è Software Versions</h3><canvas id="c-versions"></canvas></div>
    <div class="chart-box"><h3>‚ö° Jito vs Non-Jito</h3><canvas id="c-jito"></canvas></div>
  </div>`;

  html += `<div class="chart-box"><h3>üåç Geographic Distribution ‚Äî Combined SFDP Stake</h3><div id="c-map" style="width:100%;height:360px"></div>
    <div id="c-map-legend" style="margin-top:12px;font-size:12px;color:var(--dim)"></div></div>
  <div class="row3">
    <div class="chart-box"><h3>üåç Stake by Continent</h3><canvas id="c-continent-pie"></canvas></div>
    <div class="chart-box"><h3>üåç Stake by Country</h3><canvas id="c-country-pie"></canvas></div>
    <div class="chart-box"><h3>üè¢ ASN Distribution (Top 10)</h3><canvas id="c-asn-pie"></canvas></div>
  </div>
  <div class="row3">
    <div class="chart-box"><h3>üì• Stake Sources (Top 30 Validators)</h3><canvas id="c-stake-sources"></canvas></div>
    <div class="chart-box"><h3>üí∞ Commission Comparison</h3><canvas id="c-commissions"></canvas></div>
    <div class="chart-box"><h3>üìä Decentralization Comparison</h3><canvas id="c-decent"></canvas></div>
  </div>`;

  // Infrastructure concentration alerts
  html += `<div class="chart-box"><h3>üèóÔ∏è Infrastructure Concentration Risk</h3>
    <div id="c-infra-table"></div></div>`;

  // Commission compliance
  if (compliance.highCommissionCount > 0 || compliance.jitoOverCapCount > 0) {
    html += `<div class="chart-box" style="border-color:var(--red)"><h3>‚ö†Ô∏è Commission Compliance Flags</h3>
      <div id="c-compliance"></div></div>`;
  }

  html += `<div class="chart-box"><h3>Top 30 Combined Validators</h3><div id="c-top30-list"></div></div>`;

  // Build a lookup map for network stake
  const netStakeMap = {};
  for (const v of [...f.validators, ...m.validators]) {
    if (v.totalNetworkStake > 0 && (!netStakeMap[v.voter] || v.totalNetworkStake > netStakeMap[v.voter])) {
      netStakeMap[v.voter] = v.totalNetworkStake;
    }
  }
  const rows = c.topValidators.map((v,i)=>{
    const netStake = netStakeMap[v.voter] || 0;
    const sfdpPctOfVal = netStake > 0 ? (v.totalStake / netStake * 100).toFixed(1) + '%' : 'N/A';
    return [
      i+1,
      `<span class="mono">${v.voter.slice(0,16)}‚Ä¶</span>`,
      (v.name && v.name !== 'null') ? v.name : '‚Äî',
      fmt(v.totalStake) + ' SOL',
      netStake > 0 ? fmt(netStake) + ' SOL' : 'N/A',
      sfdpPctOfVal,
      v.pctOfTotal + '%<span class="bar" style="width:' + Math.max(2, parseFloat(v.pctOfTotal)*3) + 'px"></span>',
      (v.country && v.country !== 'null') ? v.country : 'N/A',
      v.commission != null ? v.commission + '%' : 'N/A',
    ];
  });
  html += `<div class="chart-box"><h3>All Combined Validators</h3>`+
    makeTable('c-table',['#','Vote Account','Name','SFDP Stake','Network Stake','SFDP % of Validator','% of SFDP Pool','Country','Comm.'],rows)+'</div>';

  el.innerHTML = html;

  // Software versions - combined
  const allVersions = {};
  for (const v of [...f.software.versions, ...m.software.versions]) {
    allVersions[v.name] = (allVersions[v.name]||0) + v.stake;
  }
  const verSorted = Object.entries(allVersions).sort((a,b)=>b[1]-a[1]);
  pieChart('c-versions',
    verSorted.map(([n,s])=>n+' ('+( s/c.totalActiveStake*100).toFixed(1)+'%)'),
    verSorted.map(([,s])=>s));

  // Jito breakdown
  const jitoStake = parseFloat(f.jitoStats.stake) + parseFloat(m.jitoStats.stake);
  const nonJitoStake = c.totalActiveStake - jitoStake;
  const jitoCount = f.jitoStats.validators + m.jitoStats.validators;
  const nonJitoCount = c.uniqueValidators - jitoCount;
  pieChart('c-jito',
    [`Jito (${jitoCount} validators, ${(jitoStake/c.totalActiveStake*100).toFixed(1)}%)`,
     `Non-Jito (${nonJitoCount} validators, ${(nonJitoStake/c.totalActiveStake*100).toFixed(1)}%)`],
    [jitoStake, nonJitoStake],
    ['#3fb950','#30363d']);

  // Country map ‚Äî combined stake
  const fCountryMap = Object.fromEntries(f.geographic.countries.map(c=>[c.name,c.stake]));
  const mCountryMap = Object.fromEntries(m.geographic.countries.map(c=>[c.name,c.stake]));
  const allCountries = [...new Set([...f.geographic.countries.map(c=>c.name),...m.geographic.countries.map(c=>c.name)])];
  const countryStakes = {};
  let maxStake = 0;
  const legendRows = [];
  for (const name of allCountries) {
    const iso = COUNTRY_ISO[name];
    const total = (fCountryMap[name]||0) + (mCountryMap[name]||0);
    if (iso && iso !== 'XX') countryStakes[iso] = total;
    if (total > maxStake) maxStake = total;
    legendRows.push({name, iso, total, firep: fCountryMap[name]||0, mpa4: mCountryMap[name]||0});
  }
  legendRows.sort((a,b) => b.total - a.total);

  new jsVectorMap({
    selector: '#c-map',
    map: 'world',
    backgroundColor: 'transparent',
    regionStyle: {
      initial: { fill: '#1b1f24', stroke: '#444c56', strokeWidth: 0.5 },
      hover: { fill: '#2d333b', cursor: 'pointer' },
    },
    series: {
      regions: [{
        values: countryStakes,
        scale: ['#2ea043', '#f0e442', '#e5534b'],
        normalizeFunction: 'polynomial',
      }]
    },
    onRegionTooltipShow(evt, tip, code) {
      const s = countryStakes[code];
      const name = tip.text();
      if (s) {
        const pctVal = (s/c.totalActiveStake*100).toFixed(1);
        const fVal = Object.entries(fCountryMap).find(([n])=>COUNTRY_ISO[n]===code);
        const mVal = Object.entries(mCountryMap).find(([n])=>COUNTRY_ISO[n]===code);
        let html = '<b>'+name+'</b><br>';
        html += 'üîµ Total: <b>'+fmt(s)+' SOL</b> ('+pctVal+'%)<br>';
        if (fVal) html += '  FiRep: '+fmt(fVal[1])+' SOL<br>';
        if (mVal) html += '  mpa4: '+fmt(mVal[1])+' SOL';
        tip.text(html, true);
      } else {
        tip.text('<b>'+name+'</b><br>No SFDP stake', true);
      }
    },
  });

  // Country legend table
  $('c-map-legend').innerHTML = '<table style="width:100%"><thead><tr><th>Country</th><th>Total Stake</th><th>FiRep</th><th>mpa4</th><th>% of Combined</th></tr></thead><tbody>' +
    legendRows.map(r => `<tr><td>${r.name}</td><td>${fmt(r.total)} SOL</td><td>${fmt(r.firep)} SOL</td><td>${fmt(r.mpa4)} SOL</td><td>${(r.total/c.totalActiveStake*100).toFixed(1)}%</td></tr>`).join('') +
    '</tbody></table>';

  // Continent pie chart
  const continents = {};
  for (const r of legendRows) {
    const cont = COUNTRY_CONTINENT[r.name] || 'Other';
    if (!continents[cont]) continents[cont] = 0;
    continents[cont] += r.total;
  }
  const contSorted = Object.entries(continents).sort((a,b) => b[1] - a[1]);
  pieChart('c-continent-pie',
    contSorted.map(([name,s]) => name + ' (' + (s/c.totalActiveStake*100).toFixed(1) + '%)'),
    contSorted.map(([,s]) => s),
    ['#58a6ff','#3fb950','#bc8cff','#d29922','#f85149','#39d353']);

  // Country pie chart
  pieChart('c-country-pie',
    legendRows.slice(0,12).map(r => r.name + ' (' + (r.total/c.totalActiveStake*100).toFixed(1) + '%)'),
    legendRows.slice(0,12).map(r => r.total));

  // Combined ASN pie
  const allASNs = {};
  for (const a of f.geographic.topASNs) { allASNs[a.name] = (allASNs[a.name]||0) + a.stake; }
  for (const a of m.geographic.topASNs) { allASNs[a.name] = (allASNs[a.name]||0) + a.stake; }
  const asnSorted = Object.entries(allASNs).sort((a,b)=>b[1]-a[1]).slice(0,10);
  pieChart('c-asn-pie',
    asnSorted.map(([n,s]) => (n.length>25?n.slice(0,23)+'‚Ä¶':n) + ' (' + (s/c.totalActiveStake*100).toFixed(1) + '%)'),
    asnSorted.map(([,s]) => s));

  // Decentralization comparison
  barChart('c-decent',['Nakamoto Coeff','Validators','HHI √ó 10k','Gini √ó 100'],[
    {label:'FiRep',data:[f.decentralization.nakamotoCoeff33,f.activeValidators,(f.decentralization.hhi*10000),(f.decentralization.gini*100)],backgroundColor:'#58a6ff'},
    {label:'mpa4',data:[m.decentralization.nakamotoCoeff33,m.activeValidators,(m.decentralization.hhi*10000),(m.decentralization.gini*100)],backgroundColor:'#bc8cff'},
  ], {isCount:true, yLabel:'Value'});

  // Stake sources pie
  if (c.stakeSources && c.stakeSources.length > 0) {
    const srcTotal = c.stakeSources.reduce((s,v) => s + v.stake, 0);
    pieChart('c-stake-sources',
      c.stakeSources.map(s => s.name + ' (' + (s.stake/srcTotal*100).toFixed(1) + '%)'),
      c.stakeSources.map(s => s.stake),
      ['#58a6ff','#3fb950','#bc8cff','#d29922','#f85149','#39d353']);
  }

  // Commission comparison
  const allComm = new Set([...f.commissionDistribution.map(c=>c.name),...m.commissionDistribution.map(c=>c.name)]);
  const commList = [...allComm].sort((a,b)=>Number(a)-Number(b));
  const fCommMap = Object.fromEntries(f.commissionDistribution.map(c=>[c.name,c.count]));
  const mCommMap = Object.fromEntries(m.commissionDistribution.map(c=>[c.name,c.count]));
  barChart('c-commissions', commList.map(c=>c+'% commission'), [
    {label:'FiRep Validators',data:commList.map(c=>fCommMap[c]||0),backgroundColor:'#58a6ff'},
    {label:'mpa4 Validators',data:commList.map(c=>mCommMap[c]||0),backgroundColor:'#bc8cff'},
  ],{stacked:true, isCount:true, xLabel:'Commission Rate', yLabel:'Number of Validators'});

  // Infrastructure concentration table
  if (infra.topASNs) {
    const totalS = c.totalActiveStake;
    $('c-infra-table').innerHTML = `<table><thead><tr>
      <th>Hosting Provider / ASN</th><th>Validators</th><th>Stake</th><th>% of SFDP</th><th>Risk</th>
    </tr></thead><tbody>${infra.topASNs.map(a => {
      const p = parseFloat(a.pct);
      const risk = p > 15 ? '<span class="badge badge-red">HIGH</span>' : p > 10 ? '<span class="badge" style="background:rgba(210,153,34,.15);color:var(--orange)">MEDIUM</span>' : '<span class="badge badge-green">LOW</span>';
      return `<tr><td>${a.name}</td><td>${a.count}</td><td>${fmt(a.stake)} SOL</td><td>${a.pct}%<span class="bar" style="width:${Math.max(2,p*3)}px;background:${p>15?'var(--red)':p>10?'var(--orange)':'var(--green)'}"></span></td><td>${risk}</td></tr>`;
    }).join('')}</tbody></table>`;
  }

  // Compliance flags
  if (compliance.highCommissionCount > 0 || compliance.jitoOverCapCount > 0) {
    let compHtml = '';
    if (compliance.highCommission?.length) {
      compHtml += '<p style="color:var(--red);margin-bottom:8px"><b>Validators exceeding 10% commission:</b></p>';
      compHtml += compliance.highCommission.map(v => `<span class="mono">${v.voter.slice(0,16)}‚Ä¶</span> ${(v.name&&v.name!=='null')?v.name:''} ‚Äî ${v.commission}% commission, ${fmt(v.stake)} SOL`).join('<br>');
    }
    if (compliance.jitoOverCap?.length) {
      compHtml += '<p style="color:var(--orange);margin:8px 0"><b>Jito validators exceeding 10% (1000 bps) Jito commission:</b></p>';
      compHtml += compliance.jitoOverCap.map(v => `<span class="mono">${v.voter.slice(0,16)}‚Ä¶</span> ${(v.name&&v.name!=='null')?v.name:''} ‚Äî ${(v.jitoCommission/100).toFixed(0)}% Jito commission, ${fmt(v.stake)} SOL`).join('<br>');
    }
    const compEl = $('c-compliance');
    if (compEl) compEl.innerHTML = compHtml;
  }

  const t30 = c.topValidators.slice(0,30);
  $('c-top30-list').innerHTML = `<div class="tw"><table><thead><tr>
    <th>#</th><th>Validator</th><th>SFDP Stake</th><th>Total Network Stake</th><th>SFDP % of Their Stake</th><th>% of SFDP Pool</th><th>Country</th><th>Comm.</th>
  </tr></thead><tbody>${t30.map((v,i)=>{
    const ns = netStakeMap[v.voter] || 0;
    const depPct = ns > 0 ? (v.totalStake / ns * 100).toFixed(1) + '%' : 'N/A';
    const vName = (v.name && v.name !== 'null' && v.name !== 'undefined') ? v.name : '';
    const vCountry = (v.country && v.country !== 'null' && v.country !== 'undefined') ? v.country : 'N/A';
    return `<tr>
      <td>${i+1}</td>
      <td>${vName?'<b>'+vName+'</b><br>':''}<span class="mono">${v.voter.slice(0,16)}‚Ä¶</span></td>
      <td><b>${fmt(v.totalStake)} SOL</b></td>
      <td>${ns>0?fmt(ns)+' SOL':'N/A'}</td>
      <td>${depPct}</td>
      <td>${v.pctOfTotal}%</td>
      <td>${vCountry}</td>
      <td>${v.commission!=null?v.commission+'%':'N/A'}</td>
    </tr>`;
  }).join('')}</tbody></table></div>`;
}

async function init() {
  D = await (await fetch('data/latest.json')).json();
  $('meta').textContent = `Epoch ${D.epoch} (${D.epochPct}%) ¬∑ ${new Date(D.timestamp).toLocaleString()} ¬∑ Slot ${D.slot.toLocaleString()} ¬∑ ${D.networkValidators} network validators`;

  renderCombined();
}

init();
</script>
</body>
</html>
